<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feedback Curation</title>
  <style>
    :root {
      --bg: #f3efe6;
      --card: #fffdf8;
      --ink: #1f2933;
      --muted: #5a6b76;
      --edge: #d8cbb3;
      --accent: #d97706;
      --positive: #0f766e;
      --neutral: #334155;
      --negative: #be123c;
      --bug: #7c3aed;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Avenir Next", "Trebuchet MS", "Gill Sans", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 20% -10%, #ffe7b0 0%, transparent 35%),
        radial-gradient(circle at 100% 0%, #fed7aa 0%, transparent 32%),
        var(--bg);
      min-height: 100vh;
    }

    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 20px;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .panel, .main {
      background: color-mix(in srgb, var(--card) 88%, white);
      border: 1px solid var(--edge);
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(60, 40, 10, 0.08);
    }

    .panel {
      padding: 16px;
      position: sticky;
      top: 16px;
      height: calc(100vh - 32px);
      overflow: auto;
    }

    h1 {
      font-size: 1.2rem;
      margin: 0 0 8px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .hint {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .row { margin-top: 14px; }
    .howto {
      margin-top: 12px;
      border: 1px solid var(--edge);
      border-radius: 10px;
      padding: 10px;
      background: #fff;
      font-size: 0.84rem;
      color: var(--muted);
      line-height: 1.45;
    }
    .howto b {
      display: block;
      margin-bottom: 6px;
      color: var(--ink);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.76rem;
    }
    label {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    select, input[type="search"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--edge);
      border-radius: 10px;
      background: #fff;
      font: inherit;
      color: var(--ink);
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 14px;
    }
    .stat {
      border: 1px solid var(--edge);
      border-radius: 10px;
      padding: 8px;
      background: #fff;
      font-size: 0.85rem;
    }
    .stat b { display: block; font-size: 1.1rem; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: 1px solid var(--edge);
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
      color: var(--ink);
      cursor: pointer;
      font: inherit;
    }
    .btn:hover { border-color: var(--accent); }
    .btn.primary {
      background: var(--accent);
      color: white;
      border-color: #b45309;
    }

    .main {
      padding: 20px;
      display: grid;
      gap: 16px;
      align-content: start;
      animation: in 280ms ease-out;
    }
    @keyframes in {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.86rem;
      color: var(--muted);
    }
    .chip {
      border: 1px solid var(--edge);
      border-radius: 999px;
      padding: 4px 10px;
      background: #fff;
    }

    .block {
      border: 1px solid var(--edge);
      border-radius: 12px;
      padding: 16px;
      background: #fff;
    }
    .block h2 {
      margin: 0 0 8px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    .feedback {
      white-space: pre-wrap;
      line-height: 1.5;
      font-size: 1.04rem;
    }

    .actions {
      display: grid;
      grid-template-columns: repeat(4, minmax(120px, 1fr));
      gap: 10px;
    }
    .label-btn {
      border: 0;
      border-radius: 12px;
      padding: 13px 10px;
      font: inherit;
      font-weight: 700;
      cursor: pointer;
      color: #fff;
    }
    .label-btn[data-label="positive"] { background: var(--positive); }
    .label-btn[data-label="neutral"] { background: var(--neutral); }
    .label-btn[data-label="negative"] { background: var(--negative); }
    .label-btn[data-label="bug"] { background: var(--bug); }
    .label-btn.selected { outline: 3px solid #f8fafc; box-shadow: 0 0 0 4px #111827; }

    .nav {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .empty {
      text-align: center;
      padding: 60px 16px;
      color: var(--muted);
    }

    @media (max-width: 960px) {
      .app { grid-template-columns: 1fr; }
      .panel { position: static; height: auto; }
      .actions { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <h1>Curator Labeling</h1>
      <p class="hint">Shortcuts: <b>1</b>=positive, <b>2</b>=neutral, <b>3</b>=negative, <b>4</b>=bug, <b>J/K</b>=next/prev</p>
      <div class="howto">
        <b>How This Works</b>
        1. Filter by board/search if needed.<br />
        2. Read the prompt + feedback on the right.<br />
        3. Assign one label: Positive, Neutral, Negative, or Bug.<br />
        4. Move with J/K (or Prev/Next).<br />
        5. Labels autosave in this browser; use <i>Download labels</i> to export JSON.
      </div>

      <div class="stats" id="stats"></div>

      <div class="row">
        <label for="annotatorName">Annotator Name</label>
        <input id="annotatorName" type="search" placeholder="Your name..." />
      </div>

      <div class="row">
        <label for="board">Board</label>
        <select id="board"></select>
      </div>

      <div class="row">
        <label for="search">Search</label>
        <input id="search" type="search" placeholder="Filter text..." />
      </div>

      <div class="row">
        <label><input type="checkbox" id="unlabeledOnly" /> Unlabeled only</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="hideHeadings" /> Hide heading-like notes</label>
      </div>

      <div class="row">
        <button class="btn primary" id="downloadBtn">Download labels</button>
      </div>
      <div class="row">
        <button class="btn" id="clearBtn">Clear local labels</button>
      </div>
    </aside>

    <main class="main" id="main"></main>
  </div>

  <script>
    const STORE_KEY = "feedback_curation_labels_v1";
    const ANNOTATOR_KEY = "feedback_curation_annotator_name_v1";
    const state = {
      items: [],
      filtered: [],
      labels: {},
      index: 0,
      annotatorName: "",
    };

    function loadLabels() {
      try {
        state.labels = JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
      } catch {
        state.labels = {};
      }
    }

    function saveLabels() {
      localStorage.setItem(STORE_KEY, JSON.stringify(state.labels));
    }

    function loadAnnotator() {
      state.annotatorName = (localStorage.getItem(ANNOTATOR_KEY) || "").trim();
      const input = document.getElementById("annotatorName");
      if (input) input.value = state.annotatorName;
    }

    function saveAnnotator(name) {
      state.annotatorName = (name || "").trim();
      localStorage.setItem(ANNOTATOR_KEY, state.annotatorName);
    }

    function boardOptions() {
      const set = new Set(state.items.map(i => i.board_id));
      return ["all", ...Array.from(set).sort()];
    }

    function refreshFilter() {
      const board = document.getElementById("board").value;
      const q = document.getElementById("search").value.trim().toLowerCase();
      const unlabeled = document.getElementById("unlabeledOnly").checked;
      const hideHeadings = document.getElementById("hideHeadings").checked;
      state.filtered = state.items.filter(item => {
        if (board !== "all" && item.board_id !== board) return false;
        if (unlabeled && state.labels[item.item_id]) return false;
        if (hideHeadings && item.auto_flags?.heading_like) return false;
        if (q && !(item.feedback_text + " " + (item.question || "")).toLowerCase().includes(q)) return false;
        return true;
      });
      if (state.index >= state.filtered.length) state.index = Math.max(0, state.filtered.length - 1);
      render();
    }

    function renderStats() {
      const total = state.items.length;
      const labeled = state.items.filter(i => state.labels[i.item_id]).length;
      const remaining = total - labeled;
      const pct = total ? Math.round((labeled / total) * 100) : 0;
      document.getElementById("stats").innerHTML = `
        <div class="stat"><b>${total}</b>Total</div>
        <div class="stat"><b>${labeled}</b>Labeled</div>
        <div class="stat"><b>${remaining}</b>Remaining</div>
        <div class="stat"><b>${pct}%</b>Complete</div>
      `;
    }

    function labelCurrent(label) {
      const item = state.filtered[state.index];
      if (!item) return;
      state.labels[item.item_id] = {
        sentiment_label: label,
        labeled_at: new Date().toISOString(),
        labeled_by: state.annotatorName || null,
      };
      saveLabels();
      render();
      if (state.index < state.filtered.length - 1) state.index += 1;
      render();
    }

    function render() {
      renderStats();
      const main = document.getElementById("main");
      const item = state.filtered[state.index];
      if (!item) {
        main.innerHTML = `<div class="empty">No items match current filters.</div>`;
        return;
      }
      const labeled = state.labels[item.item_id]?.sentiment_label || null;
      main.innerHTML = `
        <div class="meta">
          <span class="chip">Item ${state.index + 1} / ${state.filtered.length}</span>
          <span class="chip">${item.item_id}</span>
          <span class="chip">${item.board_id}</span>
          <span class="chip">${item.source_file}</span>
          <span class="chip">${item.auto_flags?.word_count ?? "?"} words</span>
          ${item.auto_flags?.heading_like ? `<span class="chip">heading-like</span>` : ""}
        </div>

        <section class="block">
          <h2>Prompt</h2>
          <div>${item.question || "(no question mapped)"}</div>
        </section>

        <section class="block">
          <h2>Feedback</h2>
          <div class="feedback">${item.feedback_text}</div>
        </section>

        <section class="actions">
          <button class="label-btn ${labeled === "positive" ? "selected" : ""}" data-label="positive">1 Positive</button>
          <button class="label-btn ${labeled === "neutral" ? "selected" : ""}" data-label="neutral">2 Neutral</button>
          <button class="label-btn ${labeled === "negative" ? "selected" : ""}" data-label="negative">3 Negative</button>
          <button class="label-btn ${labeled === "bug" ? "selected" : ""}" data-label="bug">4 Bug</button>
        </section>

        <div class="nav">
          <button class="btn" id="prevBtn">Prev (K)</button>
          <button class="btn" id="nextBtn">Next (J)</button>
        </div>
      `;

      document.querySelectorAll(".label-btn").forEach(btn => {
        btn.addEventListener("click", () => labelCurrent(btn.dataset.label));
      });
      document.getElementById("prevBtn").addEventListener("click", () => {
        state.index = Math.max(0, state.index - 1);
        render();
      });
      document.getElementById("nextBtn").addEventListener("click", () => {
        state.index = Math.min(state.filtered.length - 1, state.index + 1);
        render();
      });
    }

    function setupControls() {
      const board = document.getElementById("board");
      board.innerHTML = boardOptions().map(v => `<option value="${v}">${v}</option>`).join("");
      document.getElementById("annotatorName").addEventListener("input", (e) => {
        saveAnnotator(e.target.value);
      });
      ["board", "search", "unlabeledOnly", "hideHeadings"].forEach(id => {
        document.getElementById(id).addEventListener("input", refreshFilter);
        document.getElementById(id).addEventListener("change", refreshFilter);
      });
      document.getElementById("downloadBtn").addEventListener("click", () => {
        const out = state.items.map(item => ({
          ...item,
          annotator_name: state.annotatorName || null,
          ...state.labels[item.item_id],
        }));
        const blob = new Blob([JSON.stringify(out, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "curator_labels.json";
        a.click();
        URL.revokeObjectURL(a.href);
      });
      document.getElementById("clearBtn").addEventListener("click", () => {
        if (!confirm("Clear all saved local labels?")) return;
        state.labels = {};
        saveLabels();
        render();
      });
    }

    document.addEventListener("keydown", (e) => {
      if (e.target.matches("input,textarea,select")) return;
      if (e.key === "1") labelCurrent("positive");
      if (e.key === "2") labelCurrent("neutral");
      if (e.key === "3") labelCurrent("negative");
      if (e.key === "4") labelCurrent("bug");
      if (e.key.toLowerCase() === "j") {
        state.index = Math.min(state.filtered.length - 1, state.index + 1);
        render();
      }
      if (e.key.toLowerCase() === "k") {
        state.index = Math.max(0, state.index - 1);
        render();
      }
    });

    async function init() {
      loadLabels();
      loadAnnotator();
      const data = await loadData();
      state.items = data.items;
      setupControls();
      refreshFilter();
    }

    async function loadData() {
      const candidates = [];
      const paramPath = new URLSearchParams(window.location.search).get("data");
      if (paramPath) candidates.push(paramPath);
      candidates.push("./feedback_items.json", "../data/feedback_items.json", "../../data/feedback_items.json");

      let lastErr = null;
      for (const path of candidates) {
        try {
          const resp = await fetch(path, { cache: "no-store" });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const payload = await resp.json();
          if (!payload?.items || !Array.isArray(payload.items)) {
            throw new Error("JSON missing items[]");
          }
          return payload;
        } catch (err) {
          lastErr = err;
        }
      }
      throw new Error(`Could not load feedback items from any source. Last error: ${lastErr?.message || "unknown"}`);
    }

    init().catch(err => {
      document.getElementById("main").innerHTML = `<div class="empty">Failed to load data: ${err.message}</div>`;
    });
  </script>
</body>
</html>
