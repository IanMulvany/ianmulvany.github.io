<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV Feedback Curation</title>
  <style>
    :root {
      --bg: #f8f4e8;
      --card: #fffdf7;
      --ink: #1f2937;
      --muted: #5b6b7a;
      --edge: #d8ccb5;
      --positive: #0f766e;
      --neutral: #334155;
      --negative: #be123c;
      --bug: #7c3aed;
      --accent: #b45309;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Avenir Next", "Trebuchet MS", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 8% 0%, #ffedbf 0%, transparent 30%),
        radial-gradient(circle at 100% 20%, #fde68a 0%, transparent 25%),
        var(--bg);
    }
    .app {
      max-width: 1440px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 16px;
    }
    .panel, .main {
      border: 1px solid var(--edge);
      border-radius: 14px;
      background: color-mix(in srgb, var(--card) 90%, white);
      box-shadow: 0 8px 20px rgba(56, 36, 12, 0.08);
    }
    .panel {
      padding: 14px;
      position: sticky;
      top: 12px;
      height: calc(100vh - 24px);
      overflow: auto;
    }
    .main {
      padding: 16px;
      display: grid;
      gap: 12px;
      align-content: start;
    }
    h1 {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 1rem;
    }
    .hint { margin: 8px 0 0; font-size: 0.86rem; color: var(--muted); }
    .howto {
      margin-top: 10px;
      border: 1px solid var(--edge);
      border-radius: 10px;
      padding: 10px;
      background: #fff;
      color: var(--muted);
      font-size: 0.84rem;
      line-height: 1.45;
    }
    .howto b {
      display: block;
      margin-bottom: 6px;
      color: var(--ink);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.75rem;
    }
    .row { margin-top: 12px; }
    label {
      display: block;
      margin-bottom: 6px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.75rem;
    }
    select, input[type="search"], input[type="text"] {
      width: 100%;
      padding: 9px 10px;
      border: 1px solid var(--edge);
      border-radius: 9px;
      background: #fff;
      font: inherit;
      color: var(--ink);
    }
    .stats {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .stat {
      border: 1px solid var(--edge);
      border-radius: 9px;
      background: #fff;
      padding: 8px;
      font-size: 0.82rem;
    }
    .stat b { display: block; font-size: 1.05rem; }
    .btn {
      border: 1px solid var(--edge);
      border-radius: 10px;
      background: #fff;
      color: var(--ink);
      padding: 10px 12px;
      cursor: pointer;
      font: inherit;
      width: 100%;
    }
    .btn.primary {
      background: var(--accent);
      border-color: #92400e;
      color: white;
    }
    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      font-size: 0.84rem;
      color: var(--muted);
    }
    .chip {
      border: 1px solid var(--edge);
      border-radius: 999px;
      background: #fff;
      padding: 4px 9px;
    }
    .block {
      border: 1px solid var(--edge);
      border-radius: 11px;
      background: #fff;
      padding: 12px;
    }
    .block h2 {
      margin: 0 0 8px;
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    .feedback { white-space: pre-wrap; line-height: 1.55; }
    .actions {
      display: grid;
      grid-template-columns: repeat(4, minmax(120px, 1fr));
      gap: 8px;
    }
    .label-btn {
      border: 0;
      border-radius: 10px;
      color: #fff;
      font: inherit;
      font-weight: 700;
      cursor: pointer;
      padding: 12px 8px;
    }
    .label-btn[data-label="positive"] { background: var(--positive); }
    .label-btn[data-label="neutral"] { background: var(--neutral); }
    .label-btn[data-label="negative"] { background: var(--negative); }
    .label-btn[data-label="bug"] { background: var(--bug); }
    .label-btn.selected { outline: 3px solid #fff; box-shadow: 0 0 0 4px #111827; }
    .agent-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .agent-btn {
      border: 1px solid var(--edge);
      border-radius: 999px;
      background: #fff;
      color: var(--ink);
      padding: 7px 11px;
      font: inherit;
      cursor: pointer;
    }
    .agent-btn.selected {
      background: #1d4ed8;
      color: white;
      border-color: #1e40af;
    }
    .nav {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .nav .btn { width: auto; }
    .empty { text-align: center; color: var(--muted); padding: 48px 12px; }
    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
      .panel { position: static; height: auto; }
      .actions { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <h1>CSV Human Curation</h1>
      <p class="hint">Shortcuts: 1/2/3/4 for sentiment, J/K next/prev</p>
      <div class="howto">
        <b>How This Works</b>
        1. Filter items by form, source, agent, or search.<br />
        2. Label sentiment and select one or more related agents.<br />
        3. Labels are autosaved in this browser.<br />
        4. Export JSON with annotator + labels via Download.
      </div>

      <div class="stats" id="stats"></div>

      <div class="row">
        <label for="annotatorName">Annotator Name</label>
        <input id="annotatorName" type="text" placeholder="Your name..." />
      </div>
      <div class="row">
        <label for="formFilter">Form</label>
        <select id="formFilter"></select>
      </div>
      <div class="row">
        <label for="sourceFilter">Source CSV</label>
        <select id="sourceFilter"></select>
      </div>
      <div class="row">
        <label for="agentFilter">Agent Hint</label>
        <select id="agentFilter"></select>
      </div>
      <div class="row">
        <label for="search">Search</label>
        <input id="search" type="search" placeholder="Filter text..." />
      </div>
      <div class="row"><label><input type="checkbox" id="unlabeledOnly" /> Unlabeled only</label></div>
      <div class="row"><button class="btn primary" id="downloadBtn">Download labels</button></div>
      <div class="row"><button class="btn" id="clearBtn">Clear local labels</button></div>
    </aside>

    <main class="main" id="main"></main>
  </div>

  <script>
    const STORE_KEY = "csv_feedback_curation_labels_v1";
    const ANNOTATOR_KEY = "csv_feedback_annotator_name_v1";
    const AGENTS = ["novelty","scope","ethics","methodology_reporting","methodology_validation","integrity"];
    const state = { items: [], filtered: [], labels: {}, index: 0, annotatorName: "" };

    function loadLabels() {
      try { state.labels = JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }
      catch { state.labels = {}; }
    }
    function saveLabels() { localStorage.setItem(STORE_KEY, JSON.stringify(state.labels)); }
    function loadAnnotator() {
      state.annotatorName = (localStorage.getItem(ANNOTATOR_KEY) || "").trim();
      document.getElementById("annotatorName").value = state.annotatorName;
    }
    function saveAnnotator(v) {
      state.annotatorName = (v || "").trim();
      localStorage.setItem(ANNOTATOR_KEY, state.annotatorName);
    }
    function setLabelPatch(itemId, patch) {
      state.labels[itemId] = {
        related_agents_label: [],
        ...state.labels[itemId],
        ...patch,
        labeled_by: state.annotatorName || null,
        labeled_at: new Date().toISOString(),
      };
      saveLabels();
    }
    function toggleAgent(item, agent) {
      const cur = state.labels[item.item_id]?.related_agents_label || (item.agent_hint ? [item.agent_hint] : []);
      const next = cur.includes(agent) ? cur.filter(a => a !== agent) : [...cur, agent];
      setLabelPatch(item.item_id, { related_agents_label: next });
      render();
    }
    function setSentiment(item, sentiment) {
      const prevAgents = state.labels[item.item_id]?.related_agents_label || (item.agent_hint ? [item.agent_hint] : []);
      setLabelPatch(item.item_id, { sentiment_label: sentiment, related_agents_label: prevAgents });
      if (state.index < state.filtered.length - 1) state.index += 1;
      render();
    }
    function renderStats() {
      const total = state.items.length;
      const labeled = state.items.filter(i => state.labels[i.item_id]?.sentiment_label).length;
      const withAgents = state.items.filter(i => (state.labels[i.item_id]?.related_agents_label || []).length > 0).length;
      const pct = total ? Math.round(labeled * 100 / total) : 0;
      document.getElementById("stats").innerHTML = `
        <div class="stat"><b>${total}</b>Total</div>
        <div class="stat"><b>${labeled}</b>Sentiment</div>
        <div class="stat"><b>${withAgents}</b>With Agents</div>
        <div class="stat"><b>${pct}%</b>Complete</div>
      `;
    }
    function refreshFilter() {
      const form = document.getElementById("formFilter").value;
      const source = document.getElementById("sourceFilter").value;
      const agent = document.getElementById("agentFilter").value;
      const q = document.getElementById("search").value.trim().toLowerCase();
      const unlabeled = document.getElementById("unlabeledOnly").checked;
      state.filtered = state.items.filter(item => {
        if (form !== "all" && item.form_type !== form) return false;
        if (source !== "all" && item.source_csv !== source) return false;
        if (agent !== "all" && item.agent_hint !== agent) return false;
        if (unlabeled && state.labels[item.item_id]?.sentiment_label) return false;
        if (q && !(`${item.feedback_text} ${item.question || ""} ${item.manuscript || ""}`.toLowerCase().includes(q))) return false;
        return true;
      });
      if (state.index >= state.filtered.length) state.index = Math.max(0, state.filtered.length - 1);
      render();
    }
    function render() {
      renderStats();
      const main = document.getElementById("main");
      const item = state.filtered[state.index];
      if (!item) { main.innerHTML = `<div class="empty">No items match filters.</div>`; return; }

      const label = state.labels[item.item_id] || {};
      const sentiment = label.sentiment_label || null;
      const relatedAgents = label.related_agents_label || (item.agent_hint ? [item.agent_hint] : []);
      main.innerHTML = `
        <div class="meta">
          <span class="chip">Item ${state.index + 1} / ${state.filtered.length}</span>
          <span class="chip">${item.item_id}</span>
          <span class="chip">${item.form_type}</span>
          <span class="chip">${item.source_csv}</span>
          ${item.manuscript ? `<span class="chip">Manuscript: ${item.manuscript}</span>` : ""}
          ${item.agent_hint ? `<span class="chip">Hint: ${item.agent_hint}</span>` : ""}
        </div>

        <section class="block"><h2>Question</h2><div class="feedback">${item.question}</div></section>
        <section class="block"><h2>Feedback</h2><div class="feedback">${item.feedback_text}</div></section>

        <section class="block">
          <h2>Sentiment Label</h2>
          <div class="actions">
            <button class="label-btn ${sentiment==="positive"?"selected":""}" data-label="positive">1 Positive</button>
            <button class="label-btn ${sentiment==="neutral"?"selected":""}" data-label="neutral">2 Neutral</button>
            <button class="label-btn ${sentiment==="negative"?"selected":""}" data-label="negative">3 Negative</button>
            <button class="label-btn ${sentiment==="bug"?"selected":""}" data-label="bug">4 Bug</button>
          </div>
        </section>

        <section class="block">
          <h2>Related Agents</h2>
          <div class="agent-tags">
            ${AGENTS.map(a => `<button class="agent-btn ${relatedAgents.includes(a)?"selected":""}" data-agent="${a}">${a}</button>`).join("")}
            <button class="agent-btn" id="clearAgentsBtn">Clear</button>
          </div>
        </section>

        <div class="nav">
          <button class="btn" id="prevBtn">Prev (K)</button>
          <button class="btn" id="nextBtn">Next (J)</button>
        </div>
      `;

      document.querySelectorAll(".label-btn").forEach(btn => {
        btn.addEventListener("click", () => setSentiment(item, btn.dataset.label));
      });
      document.querySelectorAll(".agent-btn[data-agent]").forEach(btn => {
        btn.addEventListener("click", () => toggleAgent(item, btn.dataset.agent));
      });
      document.getElementById("clearAgentsBtn").addEventListener("click", () => {
        setLabelPatch(item.item_id, { related_agents_label: [] });
        render();
      });
      document.getElementById("prevBtn").addEventListener("click", () => { state.index = Math.max(0, state.index - 1); render(); });
      document.getElementById("nextBtn").addEventListener("click", () => { state.index = Math.min(state.filtered.length - 1, state.index + 1); render(); });
    }
    function setSelectOptions(id, values, labelPrefix) {
      const el = document.getElementById(id);
      el.innerHTML = ["all", ...values].map(v => `<option value="${v}">${labelPrefix}: ${v}</option>`).join("");
    }
    function setupControls() {
      setSelectOptions("formFilter", [...new Set(state.items.map(i => i.form_type))].sort(), "Form");
      setSelectOptions("sourceFilter", [...new Set(state.items.map(i => i.source_csv))].sort(), "Source");
      setSelectOptions("agentFilter", [...new Set(state.items.map(i => i.agent_hint).filter(Boolean))].sort(), "Agent");
      document.getElementById("annotatorName").addEventListener("input", e => saveAnnotator(e.target.value));
      ["formFilter","sourceFilter","agentFilter","search","unlabeledOnly"].forEach(id => {
        document.getElementById(id).addEventListener("input", refreshFilter);
        document.getElementById(id).addEventListener("change", refreshFilter);
      });
      document.getElementById("downloadBtn").addEventListener("click", () => {
        const out = state.items.map(item => ({
          ...item,
          annotator_name: state.annotatorName || null,
          ...state.labels[item.item_id],
        }));
        const blob = new Blob([JSON.stringify(out, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "csv_curator_labels.json";
        a.click();
        URL.revokeObjectURL(a.href);
      });
      document.getElementById("clearBtn").addEventListener("click", () => {
        if (!confirm("Clear all local labels?")) return;
        state.labels = {};
        saveLabels();
        render();
      });
    }
    async function loadData() {
      const candidates = [];
      const qPath = new URLSearchParams(window.location.search).get("data");
      if (qPath) candidates.push(qPath);
      candidates.push("./csv_feedback_items.json", "../../data/csv_feedback_items.json");
      let lastErr = null;
      for (const p of candidates) {
        try {
          const res = await fetch(p, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          if (!Array.isArray(payload.items)) throw new Error("Missing items[]");
          return payload;
        } catch (err) { lastErr = err; }
      }
      throw new Error(`Could not load data (${lastErr?.message || "unknown"})`);
    }
    document.addEventListener("keydown", e => {
      if (e.target.matches("input,textarea,select")) return;
      const item = state.filtered[state.index];
      if (!item) return;
      if (e.key === "1") setSentiment(item, "positive");
      if (e.key === "2") setSentiment(item, "neutral");
      if (e.key === "3") setSentiment(item, "negative");
      if (e.key === "4") setSentiment(item, "bug");
      if (e.key.toLowerCase() === "j") { state.index = Math.min(state.filtered.length - 1, state.index + 1); render(); }
      if (e.key.toLowerCase() === "k") { state.index = Math.max(0, state.index - 1); render(); }
    });
    async function init() {
      loadLabels();
      loadAnnotator();
      const payload = await loadData();
      state.items = payload.items;
      setupControls();
      refreshFilter();
    }
    init().catch(err => { document.getElementById("main").innerHTML = `<div class="empty">Failed to load: ${err.message}</div>`; });
  </script>
</body>
</html>
